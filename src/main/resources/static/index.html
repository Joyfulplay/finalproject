<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stack Overflow Data Insight</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --sidebar-width: 250px; --primary: #23272e; --accent: #4776e6; --bg: #f0f2f5; }
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); overflow: hidden; }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; display: flex; flex-direction: column; }
        .sidebar-header { padding: 25px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #3e4451; background: #2c313a; }
        .nav-item { padding: 15px 25px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; color: #abb2bf; }
        .nav-item:hover { background: #333842; color: white; }
        .nav-item.active { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(71,118,230,0.3); }
        .nav-item i { margin-right: 12px; width: 20px; }

        /* Content Area */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Controls */
        .toolbar { background: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 25px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        input, select, button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
        button { background: var(--accent); color: white; border: none; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }

        /* Charts */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); }
        .card h3 { margin-top: 0; color: #333; font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .chart-container { width: 100%; height: 450px; }

        .full-width { grid-column: 1 / -1; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header"><i class="fas fa-database"></i> SO Analyzer</div>
    <div class="nav-item active" onclick="switchView('view-trends', this)"><i class="fas fa-chart-line"></i> Topic Trends</div>
    <div class="nav-item" onclick="switchView('view-co', this)"><i class="fas fa-project-diagram"></i> Co-occurrence</div>
    <div class="nav-item" onclick="switchView('view-pitfalls', this)"><i class="fas fa-exclamation-triangle"></i> Thread Pitfalls</div>
    <div class="nav-item" onclick="switchView('view-solvability', this)"><i class="fas fa-check-double"></i> Solvability</div>
</div>

<div class="main-content">

    <!-- 1. Topic Trends View -->
    <!-- 1. Topic Trends View -->
    <div id="view-trends" class="view-section active">
        <div class="toolbar">
            <input type="date" id="startDate" value="2022-01-01">
            <span>to</span>
            <input type="date" id="endDate" value="2025-12-31">

            <!-- 更新了 placeholder -->
            <input type="text" id="tagInput"
                   placeholder="e.g. generics,lambda,spring-boot"
                   style="width: 300px;">

            <!-- 新增快捷预设按钮 -->
            <button onclick="setJavaPresets()" style="background: #2ecc71;">
                <i class="fas fa-tags"></i> Java Core
            </button>

            <select id="trendMetric">
                <option value="question_count">Question Count</option>
                <option value="total_views">Total Views</option>
                <option value="total_score">Total Score</option>
            </select>
            <button onclick="loadTrends()"><i class="fas fa-sync"></i> Analyze</button>
        </div>
        <div class="card-grid">
            <div class="card full-width"><h3>Monthly Evolution</h3><div id="trendLine" class="chart-container"></div></div>
            <div class="card full-width"><h3>Total Impact by Topic</h3><div id="trendBar" class="chart-container"></div></div>
        </div>
    </div>

    <!-- 2. Co-occurrence View -->
    <div id="view-co" class="view-section">
        <div class="toolbar">
            <label>Show Top:</label>
            <input type="number" id="coN" value="50" style="width: 60px;">
            <button onclick="loadCo()"><i class="fas fa-filter"></i> Apply</button>
        </div>
        <div class="card-grid">
            <div class="card"><h3>Top Tag Pairs (Co-occurrence)</h3><div id="coBar" class="chart-container"></div></div>
            <div class="card"><h3>Relationship Network</h3><div id="coGraph" class="chart-container"></div></div>
        </div>
    </div>

    <!-- 3. Pitfalls View -->
    <!-- 3. Pitfalls View -->
    <div id="view-pitfalls" class="view-section">
        <div class="toolbar">
            <span style="color: #666; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i>
                Analysis of common concurrency issues based on keyword frequency in Java questions.
                <span style="color: #e74c3c; margin-left:10px;">■ High Relevance</span>
                <span style="color: #f39c12; margin-left:10px;">■ Low Relevance</span>
            </span>
        </div>
        <div class="card-grid">
            <div class="card full-width">
                <h3>Multithreading Pitfall Distribution (Keyword Extraction)</h3>
                <div id="pitfallBar" class="chart-container"></div>
            </div>
            <div class="card">
                <h3>Impact Share</h3>
                <div id="pitfallPie" class="chart-container"></div>
            </div>
            <div class="card">
                <h3>Intensity Analysis (Nightingale Rose)</h3>
                <div id="pitfallRose" class="chart-container"></div>
            </div>
        </div>
    </div>

    <!-- 4. Solvability View -->
    <div id="view-solvability" class="view-section">
        <div class="card-grid">
            <div class="card full-width"><h3>Feature Comparison: Solvable vs Hard-to-Solve</h3><div id="solvRadar" class="chart-container"></div></div>
            <!-- Activity Metrics Removed -->
            <div class="card full-width"><h3>Complexity & Code Ratio</h3><div id="solvCodeBar" class="chart-container"></div></div>
        </div>
    </div>
</div>

<script>
    // --- Utility ---
    function switchView(viewId, el) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        el.classList.add('active');
        window.dispatchEvent(new Event('resize'));
    }

    // --- 1. Trends ---
    // 定义常量：符合 Stack Overflow 规范的标签名
    const JAVA_CORE_TAGS = 'spring-boot,spring,android,maven,hibernate,gradle,kotlin,jpa,intellij-idea,generics,collections,io,lambda,multithreading,sockets,reflection';

    // 快捷填充标签函数
    function setJavaPresets() {
        document.getElementById('tagInput').value = JAVA_CORE_TAGS;
        loadTrends(); // 填充后自动触发查询
    }

    // --- 1. Trends ---
    async function loadTrends() {
        // 获取输入值，如果没有输入则默认使用你指定的 Java 核心技术栈
        let tagValue = document.getElementById('tagInput').value;
        if (!tagValue) {
            tagValue = JAVA_CORE_TAGS;
            document.getElementById('tagInput').value = JAVA_CORE_TAGS;
        }

        const params = {
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            // 将输入的逗号分隔字符串转为后端需要的列表格式
            tags: tagValue.split(',').map(t => t.trim().toLowerCase())
        };

        const metric = document.getElementById('trendMetric').value;

        try {
            // 注意：axios 传递数组参数时，后端用 List<String> 接收
            // 默认 axios 会序列化为 tags[]=...，Spring 需要处理。
            // 这里使用更兼容的写法
            const res = await axios.get('/api/trends', {
                params: params,
                paramsSerializer: params => {
                    const searchParams = new URLSearchParams();
                    searchParams.append('startDate', params.startDate);
                    searchParams.append('endDate', params.endDate);
                    // 关键：将数组转换为多个同名参数，如 ?tags=lambda&tags=generics
                    params.tags.forEach(tag => searchParams.append('tags', tag));
                    return searchParams.toString();
                }
            });

            const data = res.data;
            if (!data || data.length === 0) {
                alert("No data found for the selected tags and date range.");
                return;
            }

            const months = [...new Set(data.map(d => d.month))].sort();
            const tagsInData = [...new Set(data.map(d => d.tag))];

            // --- 折线图 (Line Chart) ---
            const line = echarts.init(document.getElementById('trendLine'));
            line.setOption({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: { data: tagsInData, bottom: 0, type: 'scroll' },
                grid: { bottom: 80, left: 50, right: 50 },
                xAxis: { type: 'category', data: months },
                yAxis: { type: 'value', name: metric.replace('_', ' ') },
                series: tagsInData.map(t => ({
                    name: t,
                    type: 'line',
                    smooth: true,
                    symbol: 'circle',
                    data: months.map(m => {
                        const found = data.find(d => d.tag === t && d.month === m);
                        return found ? found[metric] : 0;
                    })
                }))
            }, true); // true 表示重绘

            // --- 柱状图 (Bar Chart) ---
            const bar = echarts.init(document.getElementById('trendBar'));
            const aggData = tagsInData.map(t => ({
                name: t,
                value: data.filter(d => d.tag === t).reduce((s, c) => s + Number(c[metric]), 0)
            })).sort((a,b) => b.value - a.value);

            bar.setOption({
                tooltip: { trigger: 'item' },
                xAxis: {
                    type: 'category',
                    data: aggData.map(i => i.name),
                    axisLabel: { rotate: 30 }
                },
                yAxis: { type: 'value' },
                series: [{
                    type: 'bar',
                    data: aggData.map(i => i.value),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#83bff6' },
                            { offset: 0.5, color: '#188df0' },
                            { offset: 1, color: '#188df0' }
                        ])
                    }
                }]
            }, true);
        } catch (error) {
            console.error("Trend Analysis Error:", error);
            alert("Analysis failed. Please check the console for details.");
        }
    }

    // --- 2. Co-occurrence ---
    async function loadCo() {
        const n = document.getElementById('coN').value;
        const res = await axios.get('/api/co-occurrence', { params: { n } });
        const data = res.data;

        const bar = echarts.init(document.getElementById('coBar'));
        bar.setOption({
            tooltip: {},
            yAxis: { type: 'category', data: data.map(d => `${d.tag1} + ${d.tag2}`).reverse() },
            xAxis: { type: 'value' },
            series: [{ type: 'bar', data: data.map(d => d.co_occurrence_count).reverse(), itemStyle: {color: '#63d3ff'} }]
        });

        const graph = echarts.init(document.getElementById('coGraph'));
        const nodes = Array.from(new Set(data.flatMap(d => [d.tag1, d.tag2]))).map(name => ({ name, symbolSize: 20 }));
        graph.setOption({
            series: [{
                type: 'graph', layout: 'force', roam: true, label: {show: true},
                data: nodes,
                links: data.map(d => ({ source: d.tag1, target: d.tag2, value: d.co_occurrence_count })),
                force: { repulsion: 300 }
            }]
        });
    }

    // --- 3. Pitfalls ---
    // --- 3. Pitfalls ---
    async function loadPitfalls() {
        try {
            const res = await axios.get('/api/pitfalls');
            const data = res.data; // 包含 pitfall_name, occurrence_count, relevance

            // 1. 柱状图：展示数量分布，并根据关联度(relevance)着色
            const bar = echarts.init(document.getElementById('pitfallBar'));
            bar.setOption({
                tooltip: { trigger: 'axis' },
                grid: { bottom: '25%' }, // 预留底部空间给旋转的标签
                xAxis: {
                    type: 'category',
                    data: data.map(d => d.pitfall_name),
                    axisLabel: { interval: 0, rotate: 35 } // 旋转35度防止长单词重叠
                },
                yAxis: { type: 'value', name: 'Occurrences' },
                series: [{
                    name: 'Mention Count',
                    type: 'bar',
                    data: data.map(d => ({
                        value: d.occurrence_count,
                        // High 为深红色，Low 为淡橙色
                        itemStyle: { color: d.relevance === 'High' ? '#e74c3c' : '#f39c12' }
                    })),
                    label: { show: true, position: 'top' }
                }]
            });

            // 2. 环形图：展示各陷阱占比
            const pie = echarts.init(document.getElementById('pitfallPie'));
            pie.setOption({
                tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                legend: { orient: 'vertical', left: 'left', textStyle: { fontSize: 10 } },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: true,
                    itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
                    label: { show: false },
                    data: data.map(d => ({ name: d.pitfall_name, value: d.occurrence_count }))
                }]
            });

            // 3. 南丁格尔玫瑰图：展示重要程度
            const rose = echarts.init(document.getElementById('pitfallRose'));
            rose.setOption({
                tooltip: { trigger: 'item' },
                visualMap: {
                    show: false,
                    min: 0,
                    max: Math.max(...data.map(d => d.occurrence_count)),
                    inRange: { colorLightness: [0.4, 0.8] }
                },
                series: [{
                    name: 'Pitfall Intensity',
                    type: 'pie',
                    radius: [20, 140],
                    center: ['50%', '50%'],
                    roseType: 'area', // 面积模式体现数量
                    itemStyle: { borderRadius: 5 },
                    data: data.map(d => ({
                        value: d.occurrence_count,
                        name: d.pitfall_name
                    })).sort((a, b) => b.value - a.value)
                }]
            });
        } catch (error) {
            console.error("Failed to load pitfalls:", error);
        }
    }
    // --- 4. Solvability ---
    async function loadSolvability() {
        const res = await axios.get('/api/solvability');
        const s = res.data.find(d => d.status === 'Solvable') || {avg_owner_reputation:0, avg_body_length:0, avg_score:0, avg_view_count:0, avg_answer_count:0, code_snippet_ratio:0, complex_topic_ratio:0};
        const h = res.data.find(d => d.status === 'Hard-to-Solve') || {avg_owner_reputation:0, avg_body_length:0, avg_score:0, avg_view_count:0, avg_answer_count:0, code_snippet_ratio:0, complex_topic_ratio:0};

        // --- Radar Chart Logic with dynamic boundary protection ---
        const metrics = [
            { key: 'avg_owner_reputation', label: 'Owner Rep' },
            { key: 'avg_body_length', label: 'Body Length' },
            { key: 'avg_score', label: 'Score' },
            { key: 'avg_view_count', label: 'Views' },
            { key: 'avg_answer_count', label: 'Answer Count' }
        ];

        // 动态计算每个维度的最大值 (取两组数据的最大值并加 20% 边距，防止贴边)
        const indicators = metrics.map(m => {
            const maxVal = Math.max(s[m.key], h[m.key]);
            return {
                name: m.label,
                max: maxVal === 0 ? 100 : Math.ceil(maxVal * 1.2)
            };
        });

        const solvRadar = echarts.init(document.getElementById('solvRadar'));
        solvRadar.setOption({
            tooltip: { trigger: 'item' },
            legend: { data: ['Solvable', 'Hard-to-Solve'], bottom: 0 },
            radar: {
                indicator: indicators,
                radius: '65%', // 缩小半径确保文字不超出
                axisName: { color: '#333', backgroundColor: '#eee', borderRadius: 3, padding: [3, 5] }
            },
            series: [{
                type: 'radar',
                emphasis: { lineStyle: { width: 4 } },
                data: [
                    {
                        value: metrics.map(m => s[m.key]),
                        name: 'Solvable',
                        areaStyle: { opacity: 0.3 }
                    },
                    {
                        value: metrics.map(m => h[m.key]),
                        name: 'Hard-to-Solve',
                        areaStyle: { opacity: 0.3 }
                    }
                ]
            }]
        });

        // Bar Chart for Ratio-based metrics
        echarts.init(document.getElementById('solvCodeBar')).setOption({
            tooltip: { trigger: 'axis' },
            legend: { data: ['Solvable', 'Hard-to-Solve'] },
            xAxis: { type: 'category', data: ['Code Snippet %', 'Complex Topic %'] },
            yAxis: { type: 'value', max: 100 },
            series: [
                { name: 'Solvable', type: 'bar', data: [s.code_snippet_ratio, s.complex_topic_ratio], itemStyle: {color: '#4776e6'} },
                { name: 'Hard-to-Solve', type: 'bar', data: [h.code_snippet_ratio, h.complex_topic_ratio], itemStyle: {color: '#ff6b6b'} }
            ]
        });
    }

    // --- Initialize ---
    window.onload = () => {
        loadTrends();
        loadCo();
        loadPitfalls();
        loadSolvability();
    };

    window.onresize = () => {
        document.querySelectorAll('.chart-container').forEach(el => {
            echarts.getInstanceByDom(el)?.resize();
        });
    };
</script>
</body>
</html>